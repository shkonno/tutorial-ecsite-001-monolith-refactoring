# 対話履歴（構造化）: 2025-12-26T11:26:38+09:00

## 1. Input（ユーザー要望）

### 1.1. リファクタリング計画の整理（背骨＝ハッピーパス）
- `work_prompt/plan.md` と `work_prompt/opus/*` を元に、まずハッピーパス分のイシューリストを作る
- 併せて、不要ドキュメント削除に向けて「参照したドキュメントが分かるリスト」を作る（ドキュメント整理方針に従う）

### 1.2. パイプライン（CI）を先に動かしたい
- GitHub Actions を先に改修して、段階的に動くようにしたい
- AWS環境は構築していない。メンテされていないAWS関連の情報・CI要素は削除してよい
- 不要ファイル削除は「あとでまとめて」行いたい。運用ルールとして参照できる場所に記載してほしい

### 1.3. lintが落ちて動かない
- `npm run lint` が多数のエラーで失敗（merge conflict marker, any, require, hooks等）
- シンプルに段階的に直すためのイシューリストが欲しい

---

## 2. Fact（観測された事実）

### 2.1. 背骨（ハッピーパス）関連
- 背骨フロー: 「商品一覧 → 詳細 → カート追加 → カート表示」
- E2E資産: `tests/user-flow.spec.ts`, `tests/e2e-navigation/*`
- フレーク要因:
  - `waitForTimeout` 依存
  - 曖昧セレクタ
  - `isVisible().catch(() => false)` による検証スキップ
- I/O境界（代表）:
  - `lib/actions/cart.ts`（DB/Auth）
  - `app/api/products/route.ts`（DB/Redis）

### 2.2. GitHub Actions の状態
- `.github/workflows/ci.yml` と `.github/workflows/deploy.yml` が既に存在していた
- CI（`ci.yml`）は lint/typecheck が中心で、テストがコメントアウトされていた
- `deploy.yml` は AWS(ECS/ECR) 前提で、main push で自動実行され得る状態だった（= AWS未運用だと赤要因）

### 2.3. lint失敗内容（ユーザー貼り付け）
- Parsing error: Merge conflict marker（複数ファイル）
- `@typescript-eslint/no-explicit-any`（複数ファイル）
- `@typescript-eslint/no-require-imports`
- `react-hooks/rules-of-hooks`（useMemoが条件付き）
- など

---

## 3. Decision（この対話で決めたこと）

### 3.1. 背骨の進め方
- まず背骨E2Eを「仕様（Living Documentation）」として固定してから、I/O境界の最小切り出しへ進む

### 3.2. CI/CD方針（AWS未運用）
- AWS(ECS)デプロイは現状の運用に不要・混乱/失敗要因になるため削除していく
- 不要ファイルは即削除せず「候補化→参照ログ→ユースケース単位でまとめて削除」のルールで運用

---

## 4. Output（作成・変更した成果物）

### 4.1. 背骨（ハッピーパス）イシューリスト
- 追加: `docs/product/refactoring-backbone-happy-path-issues.md`
  - UC-BB-01: 背骨E2E仕様化・安定化
  - UC-BB-02: I/O境界明確化→最小切り出し

### 4.2. ドキュメント管理（参照ログ・削除運用）
- 追加/更新: `docs/operations/document-management.md`
  - 参照ログ（Document Ledger）初期投入
  - 削除フロー定義
  - 運用ルール追記: 「不要ファイルは即削除せず、あとでまとめて消す」

### 4.3. docs索引の導線
- 更新: `docs/README.md`
  - 背骨イシューリストへの入口
  - ドキュメント管理（参照ログ/削除）の入口＋運用ルールの一文

### 4.4. 既存バックログへの誘導
- 更新: `docs/product/issues-and-todos.md`
  - 背骨リファクタの入口ファイルへの誘導文を追加

### 4.5. GitHub Actions（パイプライン整備）
- 更新: `.github/workflows/ci.yml`
  - PR/main/developで lint/typecheck/vitest(unit+integration)/docker build（検証）へ拡張
- 追加: `.github/workflows/e2e.yml`
  - E2E（手動実行）を分離
- 削除: `.github/workflows/test.yml`（重複していたため）
- 更新: `app/TESTING.md`
  - `ci.yml` / `e2e.yml` の実態に合わせて説明更新

### 4.6. AWSデプロイworkflowの削除
- 削除: `.github/workflows/deploy.yml`
- 参照更新（「存在しないdeploy.yml」言及の整理）:
  - `README.md`
  - `docs/architecture/folder-structure-plan.md`
  - `planning/repository-structure.md`
  - `docs/architecture/pattern-1-monolith.md`

---

## 5. Next（次にやること候補）

### 5.1. lintを段階的に直す（UC-LINT）
優先順（ハッピーパス）:
1. Merge conflict marker の撤去（Parsing errorをゼロに）
2. require()禁止をESM importへ
3. Hooksルール違反を修正
4. any撲滅（最小の意味ある型を導入）
5. warnings（img等）は後回し可

### 5.2. 不要ドキュメント削除（まとめて）
- `docs/operations/document-management.md` の「削除候補リスト」に候補を積み上げ
- ユースケース単位で一括削除

---

## 6. Files（関連ファイル一覧）
- `docs/product/refactoring-backbone-happy-path-issues.md`
- `docs/operations/document-management.md`
- `docs/README.md`
- `docs/product/issues-and-todos.md`
- `.github/workflows/ci.yml`
- `.github/workflows/e2e.yml`
- `app/TESTING.md`
- （削除済み）`.github/workflows/test.yml`
- （削除済み）`.github/workflows/deploy.yml`


