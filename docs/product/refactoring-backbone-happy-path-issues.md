# 背骨（ハッピーパス）リファクタリング：イシューリスト

本書は `work_prompt/plan.md` と `work_prompt/opus/*` を元に、**代表フロー（背骨）を起点**としてリファクタリングを進めるための、実行可能なイシューリストです。  
「まずはハッピーパス分だけ作り、型（粒度・書式・DoD）を整えて次を決める」ため、スコープを **背骨1本** に限定します。

---

## スコープ（今回）

- **対象ユースケース（背骨）**: 商品一覧 → 商品詳細 → カート追加 → カート表示
- **方針**:
  - まず背骨フローを **E2Eで“仕様（Living Documentation）”として固定**する
  - 次に背骨の経路上の **I/O境界を洗い出し**、変更が起きやすい箇所から **最小の切り出し**を行う
  - E2Eだけに依存せず、結合/ユニットで **速い安全網** を追加してから進める
- **非スコープ（今回やらない）**: 管理者機能の拡張、チェックアウト以降の最適化、UI/UXのデザイン刷新、アーキテクチャ大移動（物理移動）

---

## 参照（根拠）

- `work_prompt/plan.md`: 背骨の定義、進め方（E2E固定→境界切り出し）、ドキュメント整理方針
- `work_prompt/opus/refactoring-plan.md`: UC0-UC4構成、E2Eの課題、背骨シナリオ案
- `work_prompt/opus/current-status.md`: テスト資産とフレーク要因、I/O境界一覧
- `work_prompt/opus/backbone-io-boundary.md`: 背骨フローのI/O依存の棚卸し

---

## 粒度の約束（型）

- **ユースケース**: 評価可能な一連の作業の流れ（〜2日）
- **イシュー**: ユースケースの1要素（〜2時間）
- **タスク**: 具体作業（〜30分）

※ タスクは「TODO」ではなく **完了条件（DoD）に向けた最小の作業単位**として切る。

---

## UC-BB-01: 背骨フローを“生きた仕様”として固定する（E2E）

### BB-01: 既存E2Eから背骨シナリオを1本に絞る（棚卸し）
- **狙い**: 「背骨として確定した1本」がない問題を解消し、以後の作業の北極星にする
- **入力**: `tests/user-flow.spec.ts`, `tests/e2e-navigation/*`
- **出力**: 背骨シナリオの候補1本（暫定でOK）と、落とす/残す理由

**タスク**
- **T01**: `user-flow.spec.ts` から背骨に該当する手順を抜き出す（メモでOK）
- **T02**: フレーク要因を列挙（waitForTimeout/曖昧セレクタ/検証スキップ）
- **T03**: 背骨1本の「最小の前提」を決める（例: ログイン有無、商品データ前提）

**DoD**
- 背骨シナリオが1本に決まり、なぜそれが背骨なのかが1段落で説明できる

---

### BB-02: 背骨E2Eを Given-When-Then 形式に書き換える（仕様化）
- **狙い**: テストを **仕様書** として読める形にする（Living Documentation）
- **出力**: `tests/e2e-backbone/browse-to-cart.spec.ts`（命名は例）

**タスク**
- **T01**: シナリオを Given-When-Then の文章に起こす（Gherkin風でOK）
- **T02**: テストを1本にし、意図のコメント（Given/When/Then）をコードに埋め込む
- **T03**: エラーメッセージ/アサーションを「仕様の言葉」に寄せる

**DoD**
- 「テストコードだけ読んで、ユーザーの期待が説明できる」状態になっている

---

### BB-03: E2Eフレーク要因を削る（待ち・セレクタ・検証スキップ）
- **狙い**: `waitForTimeout` 依存や曖昧セレクタを除去し、**安定して落ちる/通る**を作る
- **注意**: UIの見た目変更はしない（テストのための `data-testid` 追加は許容）

**タスク**
- **T01**: `waitForTimeout` を “待つべき事実” への待ちに置換（表示/ネットワーク/状態）
- **T02**: `'[class*="product"], article, .card'` のような曖昧セレクタを撤廃
- **T03**: `isVisible().catch(() => false)` を撤廃し、落ちるべき時に落ちるようにする
- **T04**: 可能なら `data-testid` を導入（商品カード/カート追加/カート行）

**DoD**
- ローカルで **連続10回** 実行しても同一結果になる（成功/失敗が再現可能）

---

### BB-04: 背骨の受け入れ基準（DoD）を確定する
- **狙い**: 「何をもって背骨が固定されたか」を明確にする（迷子防止）

**タスク**
- **T01**: DoDを文章化（E2E安定/実行手順/前提データ/計測ログ）
- **T02**: 背骨の“仕様に含めないこと”（非スコープ）も明文化

**DoD**
- 背骨ユースケースの完了条件が `docs/` に残り、次の作業がそれを参照できる

---

## UC-BB-02: 背骨のI/O境界を明確化し、最小の切り出しを行う

### BB-05: 背骨I/O境界マップを docs に“昇格”する
- **狙い**: 変更の影響範囲を「図」と「表」で共有できる状態にする
- **入力**: `work_prompt/opus/backbone-io-boundary.md`
- **出力**: `docs/architecture/backbone-io-boundary.md`（Livingとして扱う）

**タスク**
- **T01**: `work_prompt/opus/backbone-io-boundary.md` を `docs/architecture/` にコピー（昇格）
- **T02**: 背骨E2Eテストへのリンクを追加（「この仕様を検証するテスト」）
- **T03**: 依存先（DB/Redis/Auth）を「変わりやすさ/壊れやすさ」の観点で一言追記

**DoD**
- 背骨のI/O境界が docs から辿れ、変更時の影響範囲の会話ができる

---

### BB-06: “最初の切り出し対象”を1箇所に決める（候補比較）
- **狙い**: いきなり全体を触らない。最小の1点から学習して横展開する
- **推奨候補（現状資料より）**: `lib/actions/cart.ts`

**改善案（3案）**
| 案 | 何をする | 良い点 | 注意点 |
|---|---|---|---|
| A: 純粋関数へ抽出（ドメイン分離） | I/O（Prisma/Auth）から計算・判断を切り離す | ユニットテストが速く・堅くなる | 入口/出口の設計が必要 |
| B: Repository/Port導入（I/O抽象化） | `CartRepository` などを導入し、Prismaを隠す | 境界が明確、結合テスト設計がしやすい | 抽象が過剰になるリスク |
| C: ユースケース単位のService化 | `AddToCart` などアプリサービスへ集約 | 入口が読みやすい、ログ/計測を入れやすい | 依存注入の方針が必要 |

**タスク**
- **T01**: 変更頻度×複雑度×テスト資産で1箇所を選ぶ（理由を1段落）
- **T02**: 採用案（A/B/C）を仮決めし、必要ならADR化の要否を判断

**DoD**
- 「最初の切り出し」が1点に決まり、採用案の理由が説明できる

---

### BB-07: 実DBを使う“真の結合テスト”を1本追加する（隙間埋め）
- **狙い**: ユニット〜E2Eの間の安全網（実I/Oで壊れないか）を作る
- **対象例**: カート操作 or 商品一覧API（どちらか1本で良い）

**タスク**
- **T01**: 結合テストのGivenを固定（DBをseedする/前提データを決める）
- **T02**: “背骨で使う最小操作”だけ検証するテストを追加
- **T03**: テスト実行の手順と依存（docker compose等）を `TESTING.md` に追記

**DoD**
- 「実DBを通した背骨の最小検証」が1本あり、失敗時に原因が追える

---

### BB-08: 安全網の下で、最初の切り出しを実施する（Refactor）
- **狙い**: E2E・結合・ユニットの安全網の下で、小さく構造を改善する

**タスク**
- **T01**: 先に “変えたい問題” を1つに絞る（責務混在/依存の直書き等）
- **T02**: 小さなリファクタを1回（Tidy First：整頓→ふるまい変更）
- **T03**: 既存ユニットテストと背骨E2Eが守っていることを確認

**DoD**
- 構造が一段階シンプルになり、テストが「設計文書」として機能している

---

## 次に型を整えるための確認ポイント（このUCが終わったら）

- イシュー/タスクの粒度は適切だったか（30分で終わらないタスクは分割できたか）
- DoDは“観測可能”だったか（連続実行回数、成果物の場所、リンク）
- 背骨の前提（データ/ログイン/環境）で曖昧さが残っていないか


