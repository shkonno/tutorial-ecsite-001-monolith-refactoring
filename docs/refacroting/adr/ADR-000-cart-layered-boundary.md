# ADR-000: カートI/O境界のレイヤ分離（たたき台）

- **Status**: Proposed  
- **Date**: 2025-12-27  
- **Owner**: （担当者名を記載）  
- **Scope / Layer**: Application + Domain / Infrastructure（cart）  
- **Related UC / Issue**: UC2 I2-2（切り出し候補の選定と作戦）  

## Context

- 背骨の「カート追加〜表示」で、アクションがデータアクセスを直接扱う前提になっており、レイヤードアーキ導入時の境界があいまい。  
- `docs/refacroting/refs/backbone-io-boundary.md` では cart が最初の切り出し候補とされている。  
- 既存設計はモノリス構成（参考: `docs/architecture/pattern-1-monolith.md`）、これを崩さずに徐々に境界を薄くしたい。  
- 制約: まず安全網を確保しつつ小さく進める（結合テスト追加を優先、E2Eは維持）。  

## Decision Drivers

| 軸 | メモ | 評点(1-5) |
| --- | --- | --- |
| 品質 | I/Oを分離しテスト容易性を上げる、単体・結合・ユーザーテストのテストケースあり、エビデンスあり、文書あり | 4 |
| 速度 | 既存コードへの影響を限定し短期で着手 | 3 |
| 安全 | 業界標準のセキュリティ対応必須、認証認可、個人情報 | 5 |
| 運用 | 段階移行・ロールバック容易性、監視/ログの責務を分離しやすくする | 2 |

## Options

### Option A: 現状維持（actions内で直接I/O）
- Pros: 着手なし、影響ゼロ  
- Cons: レイヤー責務が混在しテストが書きづらい、次の切り出し時に再度大きな変更が必要  
- リスク/軽減策: 変化なしだが技術的負債が累積  
- 影響レイヤ: Application / Infra が密結合のまま  
- テスト影響: 既存E2Eのみ依存、単体・結合の粒度が作りにくい  

### Option B: 一気にサービス層＋リポジトリ層を導入
- Pros: 理想形に早く到達、境界が明確  
- Cons: 変更範囲が広く、既存E2Eだけでは回帰リスクが高い  
- リスク/軽減策: 大量のモック差し替えが必要、移行期間は二重実装のリスク  
- 影響レイヤ: App/Domain/Infra を同時に再配線  
- テスト影響: 単体/結合テストを一気に用意する必要がある  

### Option C: リポジトリインタフェースを追加し、読み取りパスから段階移行（推奨）
- Pros: 変更を最小化しつつ境界を明文化、読み取りパスで先に安全網を作れる  
- Cons: しばらく二重経路が併存する可能性、書き込みパス対応が後続になる  
- リスク/軽減策: 既存アクションをラップする形で導入し、段階的に使用箇所を置換。結合テストでリポジトリ実装を実DBに対して検証する  
- 影響レイヤ: Application（リポジトリ利用へ変更）、Infra（実装追加）、Domain（将来サービス導入余地を確保）  
- テスト影響: 新規結合テストを1本追加（正常系）、異常系を1本追加。E2Eは現状のまま通ることを確認  

## Decision

- 採用: Option C（段階移行）  
- 理由: UC2の時間枠内で安全網を整えつつ、レイヤードアーキへの足場を作る。読み取りから進め、書き込みはフォローアップで実施する  
- スコープ: cart の読み取り/表示パスを先行対象。追加/更新/削除パスは次フェーズで置換する  

## Consequences

- 良くなること: レイヤ境界が明文化され、結合テストでI/O契約を守れる。将来のドメインサービス化が容易  
- 失う/延期すること: 一時的に二重経路が併存。書き込みパスの分離は後続  
- フォローアップ:  
  - リポジトリ実装（Infra）とその結合テスト（実DB）を追加  
  - 書き込みパスの置換を次のADR/タスクで扱う  
  - ログ/監視の粒度をリポジトリ境界で合わせる  
- 検証: UC2 I2-3 で結合テストを追加し、E2E（背骨）を3回連続実行で安定を確認  
- ロールバック: リポジトリ利用箇所を切り戻すブランチを保持し、結合テスト失敗時は即時元の呼び出しに戻せるようにする  

## Links

- 計画: `docs/refacroting/MASTER-PLAN.md`  
- 実行: `docs/refacroting/ISSUES-UC0-UC2.md`  
- 境界: `docs/refacroting/refs/backbone-io-boundary.md`  
- 現行設計: `docs/architecture/pattern-1-monolith.md`  
- テスト方針: `docs/refacroting/refs/testing-strategy.md`  

