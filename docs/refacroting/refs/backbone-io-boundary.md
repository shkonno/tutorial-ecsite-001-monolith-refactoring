# 背骨フロー I/O境界マップ

## 背骨フロー

「商品一覧 → 商品詳細 → カート追加 → カート表示」

---

## フロー図

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Frontend                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   [商品一覧]  ──click──▶  [商品詳細]  ──click──▶  [カート]          │
│   /products              /products/[id]          /cart               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
        │                        │                      │
        ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           Backend                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   GET /api/products      lib/actions/          lib/actions/          │
│   (route.ts)             product.ts            cart.ts               │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
        │                        │                      │
        ▼                        ▼                      ▼
┌─────────────────────────────────────────────────────────────────────┐
│                           I/O Layer                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│   ┌──────────┐      ┌──────────┐      ┌──────────┐                  │
│   │ Redis    │◀────▶│ Prisma   │◀────▶│ NextAuth │                  │
│   │ (cache)  │      │ (DB)     │      │ (auth)   │                  │
│   └──────────┘      └──────────┘      └──────────┘                  │
│        │                  │                 │                        │
│        ▼                  ▼                 ▼                        │
│   ┌──────────┐      ┌──────────┐      ┌──────────┐                  │
│   │ Redis    │      │PostgreSQL│      │ Session  │                  │
│   │ Server   │      │ Server   │      │ Store    │                  │
│   └──────────┘      └──────────┘      └──────────┘                  │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 各ステップのI/O依存

### Step 1: 商品一覧ページ (`/products`)

| 処理 | I/O | ファイル |
|------|-----|----------|
| 商品一覧取得 | Redis(cache) → DB | `app/api/products/route.ts` |
| ページネーション | DB | 同上 |
| カテゴリ絞り込み | DB | 同上 |
| 検索 | DB | 同上 |

### Step 2: 商品詳細ページ (`/products/[id]`)

| 処理 | I/O | ファイル |
|------|-----|----------|
| 商品詳細取得 | DB | `app/(shop)/products/[id]/page.tsx` |
| 関連商品取得 | DB | 同上（任意） |

### Step 3: カート追加

| 処理 | I/O | ファイル |
|------|-----|----------|
| 認証確認 | Auth(session) | `lib/actions/cart.ts` |
| 商品存在確認 | DB | 同上 |
| 在庫確認 | DB | 同上 |
| カートアイテム作成/更新 | DB | 同上 |
| キャッシュ無効化 | - | `next/cache` revalidatePath |

### Step 4: カート表示 (`/cart`)

| 処理 | I/O | ファイル |
|------|-----|----------|
| 認証確認 | Auth(session) | `lib/actions/cart.ts` |
| カートアイテム取得 | DB | 同上 |
| 商品情報取得（join） | DB | 同上 |

---

## 境界の複雑度評価

| 境界 | 変更頻度 | 複雑度 | テストカバレッジ | 優先度 |
|------|----------|--------|------------------|--------|
| `lib/actions/cart.ts` | 高 | 中 | 高（ユニット） | **推奨** |
| `app/api/products/route.ts` | 中 | 低 | 中（モック結合） | 次点 |
| `lib/auth.ts` | 低 | 高 | 低 | 後回し |
| `lib/redis.ts` | 低 | 低 | 低 | 後回し |

---

## 推奨: カート操作（`lib/actions/cart.ts`）を最初の切り出し対象に

**理由**:
1. **ユニットテストが充実**: 既存のテスト（540行）で動作保証がある
2. **変更頻度が高い**: ビジネスロジックの中心
3. **I/O境界が明確**: DB(Prisma) + Auth(NextAuth) の2つだけ
4. **複雑度が中程度**: 大きすぎず、学習材料として適切

**追加で必要なテスト**:
- 実DBを使った結合テスト（現在はモックのみ）
- E2Eでの安定したシナリオ

