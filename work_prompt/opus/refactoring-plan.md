# リファクタリングプラン

## 現状サマリー

### 既存資産（活用できるもの）
| 資産 | 場所 | 状態 |
|------|------|------|
| E2Eテスト | `tests/user-flow.spec.ts`, `tests/e2e-navigation/` | 背骨フローに相当するテストあり。ナビゲーション網羅 |
| ユニットテスト | `tests/unit/actions/cart.test.ts` | 540行、高品質。カート操作のビジネスロジックを網羅 |
| 結合テスト | `tests/integration/api/products.test.ts` | 商品APIのテスト（ただしモック使用） |
| ドキュメント | `docs/` | 整理済み。ADR 1件あり |
| I/O境界 | `lib/db.ts`, `lib/redis.ts`, `lib/auth.ts`, `lib/s3.ts` | Prisma, Redis, NextAuth, S3 |

### 課題（改善ポイント）
1. **E2Eがフレークしやすい**: `waitForTimeout`依存、曖昧なセレクタ、`isVisible().catch(() => false)`で検証スキップ
2. **「背骨」として確定した1本のシナリオがない**: Given-When-Then形式で仕様化されていない
3. **結合〜E2E間に隙間**: 実際のDB/Redisを使った真の結合テストがない
4. **計測ルール/ADRルールが未定義**: plan.mdに方針はあるが運用ルールがない

---

## フェーズ構成

```
UC0: ガードレール策定
    ↓
UC1: 背骨E2E仕様化・安定化
    ↓
UC2: 背骨経路の境界切り出し
    ↓
UC3: 横展開（2本目以降の背骨）

UC4: 指標の可視化（UC0, UC1と並行可）
```

---

## UC0: ガードレール策定（迷子防止）

**目的**: 計測と意思決定のルールを先に固めて、作業中の判断ブレを防ぐ

### イシュー一覧

#### I0-1: 作業時間計測ルール策定
- **タスク**: 計測対象（アクティブ/待ち/調査）の定義、記録テンプレ作成
- **成果物**: `docs/operations/work-time-tracking.md`

#### I0-2: ADR運用ルール策定
- **タスク**: テンプレ確定、3案比較軸定義、作成トリガー定義
- **成果物**: `docs/architecture/decisions/ADR-TEMPLATE.md`

#### I0-3: ドキュメント昇格ルール策定
- **タスク**: `docs/`に残す基準、索引作成
- **成果物**: `docs/README.md`（索引追記）

---

## UC1: 背骨E2E仕様化・安定化

**目的**: 「商品一覧→詳細→カート追加→カート表示」を1本の確定したE2Eとして固定し、Living Documentationの起点にする

### イシュー一覧

#### I1-1: 既存E2Eの棚卸し
- **タスク**: `user-flow.spec.ts`の「商品閲覧・カート追加フロー」を分析、フレーク要因を列挙
- **対象**: `tests/user-flow.spec.ts`

#### I1-2: 背骨E2E 1本を書き換え
- **タスク**: Given-When-Then形式で明文化、セレクタ安定化、`waitForTimeout`除去
- **成果物**: `tests/e2e-backbone/browse-to-cart.spec.ts`

#### I1-3: DoD（受け入れ基準）確定
- **タスク**: 背骨ユースケースの完了条件を定義（E2Eパス/計測記録/ログ確認）
- **成果物**: `work_prompt/plan.md`に追記

### 背骨フローの仕様（Given-When-Then案）

```gherkin
Feature: 商品をカートに追加する

  Background:
    Given ユーザーはログイン済みである

  Scenario: 商品一覧から商品を選んでカートに追加する
    Given 商品一覧ページを開いている
    When 最初の商品カードをクリックする
    Then 商品詳細ページが表示される
    When 「カートに追加」ボタンをクリックする
    Then 「カートに追加しました」メッセージが表示される
    When カートページを開く
    Then 追加した商品がカートに表示される
```

---

## UC2: 背骨経路の境界切り出し

**目的**: 背骨フロー経路上のI/O境界を特定し、変更が起きやすい箇所に「速い安全網」を追加してからリファクタ

### イシュー一覧

#### I2-1: I/O境界マップ作成
- **タスク**: 背骨経路のDB/Redis/Auth依存を図示
- **成果物**: `docs/architecture/backbone-io-boundary.md`

#### I2-2: 切り出し候補の選定
- **タスク**: 変更頻度/複雑度で1箇所選ぶ
- **推奨**: カート操作 `lib/actions/cart.ts`

#### I2-3: 結合テスト追加
- **タスク**: 選んだ箇所に対して、実DBを使った結合テストを追加（既存ユニットテストは維持）
- **成果物**: `tests/integration/actions/cart.integration.test.ts`

#### I2-4: リファクタ実施
- **タスク**: 安全網を確認してから構造改善
- **対象**: `lib/actions/cart.ts`

### 背骨経路のI/O境界マップ（概念）

```
[Frontend]
  商品一覧ページ → 商品詳細ページ → カートページ
       ↓                ↓              ↓
[Backend]
  GET /api/products   lib/actions/cart.ts
       ↓                    ↓
[I/O]
  PostgreSQL/Prisma ←→ Redis(cache) ←→ NextAuth(session)
```

---

## UC3: 横展開（2本目以降の背骨）

**目的**: 背骨が安定したら、同じ手順で他の代表フローに拡大

| 候補フロー | 優先度 | 理由 |
|------------|--------|------|
| チェックアウト→注文作成 | 高 | ビジネス価値が高い、決済境界の特定が必要 |
| ログイン/登録 | 中 | 認証境界の明確化、セキュリティ観点 |
| 管理者: 商品作成/編集 | 中 | 管理機能の仕様化、権限境界の特定 |

---

## UC4: 指標の可視化

**目的**: 作業時間の推移を見える化し、「工数が跳ね上がっていないか」を検知できるようにする

### イシュー一覧

#### I4-1: 作業時間ログの集計
- **タスク**: ユースケースごとの作業時間を記録・集計
- **成果物**: スプレッドシート or `docs/metrics/`

#### I4-2: 補助指標の検討
- **タスク**: 作業時間が跳ねた原因を説明する指標（テスト実行時間/依存数/循環参照など）
- **成果物**: ADRで判断

---

## 着手順序と依存関係

| 順序 | ユースケース | 前提 | 期間目安 |
|------|--------------|------|----------|
| 1 | UC0: ガードレール策定 | なし | 2時間 |
| 2 | UC1: 背骨E2E仕様化・安定化 | UC0完了 | 4-6時間 |
| 3 | UC2: 背骨境界切り出し | UC1完了 | 4-6時間 |
| 4 | UC3: 横展開 | UC2完了 | 都度 |
| 並行 | UC4: 指標可視化 | UC0完了 | 随時 |

---

## 次のアクション（最初の一歩）

**UC0-I0-1: 作業時間計測ルールの策定**から始める

1. 計測対象（アクティブ作業/待ち/調査）の定義
2. 記録フォーマット（テンプレ）の作成
3. `docs/operations/work-time-tracking.md` として保存

