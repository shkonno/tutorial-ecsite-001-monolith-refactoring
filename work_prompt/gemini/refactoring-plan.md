# リファクタリング詳細計画 (Gemini版)

`work_prompt/plan.md` の戦略（全体スコープ、E2E背骨起点、ドキュメント昇格C案、作業時間指標）に基づく、具体的な実行タスクリストです。

## 構造
計画は以下の階層で管理します：
- **UseCase (UC)**: 完了するとユーザー/開発者に明確な価値が出る単位
- **Issue**: UCを構成する作業の塊（2時間〜半日程度）
- **Task**: 具体的な作業手順（30分程度）

---

## Phase 1: 準備とガードレールの設置 (Day 1-2)
迷子にならず、かつ効果計測ができる状態を最初に作ります。

### UC0: リファクタリングの基盤整備
**完了条件**: 指標計測が開始され、ドキュメントの「正/副」が定義され、ADRを書く場所がある状態。

- **Issue 0-1: 作業時間計測のルール策定と環境用意**
  - [ ] Task: 計測単位（ユースケース/Issue）と記録場所（GitHub Projects/スプレッドシート等）の決定
  - [ ] Task: ノイズ（待ち時間/学習時間）の分離・記録ルールの明文化
  - [ ] Task: 最初の計測開始（このUC0自体の時間を測る）

- **Issue 0-2: ドキュメント索引と昇格ルールの整備（C案）**
  - [ ] Task: 既存ドキュメントの「索引（Map）」作成（物理移動はせず、リスト化のみ）
  - [ ] Task: `docs/` への昇格基準（Living Documentationの定義）の策定
  - [ ] Task: `work_prompt/` 内の扱いを決める

- **Issue 0-3: ADR（意思決定ログ）運用の開始**
  - [ ] Task: ADRテンプレートの配置（3案比較検討項目を含む）
  - [ ] Task: 意思決定トリガーの定義（例：境界変更、データモデル変更時は必須）

---

## Phase 2: 背骨（Backbone）の仕様固定 (Day 3-5)
まだコードの内部構造はいじらず、現状の挙動を「正」としてE2Eテストで固定します。

### UC1: 代表フロー（商品閲覧〜カート）のE2E固定
**完了条件**: `browse-to-cart` フローのE2EテストがCIで安定してパスし、仕様書として読める状態になること。

- **Issue 1-1: Playwright環境の確認と整備**
  - [ ] Task: 現状のテスト実行可否と環境依存（DB等）の確認
  - [ ] Task: テストデータ投入/リセットの仕組み確認（`prisma/seed.ts` 等）

- **Issue 1-2: "背骨"シナリオの実装**
  - [ ] Task: シナリオ記述（Given-When-Then形式）
    - 商品一覧を見る -> 詳細を開く -> カートに入れる -> カート内に商品があることを確認
  - [ ] Task: Playwrightによる実装
  - [ ] Task: CIでの実行安定化（Flaky排除）

- **Issue 1-3: 受け入れ基準（DoD）の確立**
  - [ ] Task: 「壊れていない」の定義を明文化（E2E成功 + エラーログなし + レイアウト崩れなし等）

---

## Phase 3: 境界の切り出し（リファクタリング本番） (Day 6-10)
固定されたE2Eを安全網にして、内部構造に手を入れていきます。

### UC2: I/O境界と依存関係の整理
**完了条件**: 特定のドメインロジック（例: Cart）がIOから分離され、Unitテストで保護されていること。

- **Issue 2-1: 依存関係の可視化と切断箇所の特定**
  - [ ] Task: 背骨フロー上のI/O（DB, API, Auth）の洗い出し（マップ化）
  - [ ] Task: 最初に対処する「最小の切り出し候補」の決定（例: カート計算ロジック、在庫チェック等）
  - [ ] Task: **[ADR]** アーキテクチャ変更方針の決定（何をどう分離するか）

- **Issue 2-2: ロジックの分離とテストピラミッドの適正化**
  - [ ] Task: 切り出すロジックに対するUnit/Integrationテストの作成（E2Eより速いフィードバック）
  - [ ] Task: 実装の分離（リファクタリング実施）
  - [ ] Task: E2Eでの回帰確認（既存テストが通ること）

---

## Phase 4: 横展開と運用 (Day 11~)
成功パターンを他のフローへ広げます。

### UC3: 次の代表フローへの展開
**完了条件**: 2本目の背骨フローが同様に処理されること。

- **Issue 3-1: 次の背骨の選定と実施**
  - [ ] Task: 認証フロー（Login/Register）または 注文フロー（Checkout）の選定
  - [ ] Task: Phase 2-3 のサイクル繰り返し

